<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.insurance.audit.product.infrastructure.mapper.DocumentMapper">

    <!-- 结果映射 -->
    <resultMap id="BaseResultMap" type="com.insurance.audit.product.domain.entity.Document">
        <id column="id" property="id" jdbcType="VARCHAR"/>
        <result column="file_name" property="fileName" jdbcType="VARCHAR"/>
        <result column="file_path" property="filePath" jdbcType="VARCHAR"/>
        <result column="file_size" property="fileSize" jdbcType="BIGINT"/>
        <result column="file_type" property="fileType" jdbcType="VARCHAR"/>
        <result column="document_type" property="documentType" jdbcType="VARCHAR"
                typeHandler="org.apache.ibatis.type.EnumTypeHandler"/>
        <result column="product_id" property="productId" jdbcType="VARCHAR"/>
        <result column="upload_status" property="uploadStatus" jdbcType="VARCHAR"
                typeHandler="org.apache.ibatis.type.EnumTypeHandler"/>
        <result column="audit_status" property="auditStatus" jdbcType="VARCHAR"
                typeHandler="org.apache.ibatis.type.EnumTypeHandler"/>
        <result column="created_time" property="createdTime" jdbcType="TIMESTAMP"/>
        <result column="updated_time" property="updatedTime" jdbcType="TIMESTAMP"/>
        <result column="created_by" property="createdBy" jdbcType="VARCHAR"/>
        <result column="updated_by" property="updatedBy" jdbcType="VARCHAR"/>
        <result column="deleted" property="deleted" jdbcType="TINYINT"/>
        <result column="version" property="version" jdbcType="INTEGER"/>
    </resultMap>

    <!-- 基础列名 -->
    <sql id="Base_Column_List">
        id, file_name, file_path, file_size, file_type, document_type, product_id,
        upload_status, audit_status, created_time, updated_time, created_by, updated_by,
        deleted, version
    </sql>

    <!-- 根据产品ID查询文档列表 -->
    <select id="selectByProductId" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM documents
        WHERE product_id = #{productId}
        AND deleted = 0
        ORDER BY created_time DESC
    </select>

    <!-- 根据产品ID和要件类型查询文档 -->
    <select id="selectByProductIdAndType" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM documents
        WHERE product_id = #{productId}
        AND document_type = #{documentType}
        AND deleted = 0
        ORDER BY created_time DESC
        LIMIT 1
    </select>

    <!-- 统计产品的文档数量 -->
    <select id="countByProductId" resultType="java.lang.Integer">
        SELECT COUNT(*)
        FROM documents
        WHERE product_id = #{productId}
        AND deleted = 0
    </select>

    <!-- 根据产品ID和上传状态查询文档列表 -->
    <select id="selectByProductIdAndStatus" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM documents
        WHERE product_id = #{productId}
        AND upload_status = #{uploadStatus}
        AND deleted = 0
        ORDER BY created_time DESC
    </select>

</mapper>