# 智能检核引擎（intelligent-audit-engine）- 需求说明（Requirements）

## 1. 概述
- **目标**：构建支持保险产品全要件（条款、精算、费率、信息登记表、可行性报告等）的智能检核引擎，通过“关键词/正则 + 语义相似度 + 语义/LLM”的多层策略，实现高查全率、查准率和可追溯的检核结果，支持批量与单件检核。
- **背景**：依据北京银保监局发布的备案审核要点及公司内控制度，需将不少于150条可落地规则配置为系统可执行的检核规则，并支撑报备前自查与报备后历史产品批量自查整改。
- **范围**：本文件界定智能检核引擎模块的功能/非功能需求、角色与用例、规则治理与生命周期、接口与集成、数据与性能、安全与合规等。
- **不在范围（本阶段）**：
  - 非保险领域通用文档审校；
  - 图像/扫描件OCR识别能力建设（若提供则作为输入预处理，不在本模块内实现）；
  - OA 审批流相关（本阶段不对接）；
  - 规则创建/修改/导入/模板维护/审核流程等：由 `rule-configuration-system` 承担，本模块不实现；
  - LLM 服务编排平台本体（由 `llm-service-management` 模块承担）。

## 2. 干系人与角色
- **业务规则负责人（Rule Owner）**：提出/维护规则，发起规则评估与上线流程。
- **技术评估人员（Tech Evaluator）**：评估规则可实现性、选择实现方式（关键词/语义/LLM/格式/高级）。
- **审核人员（Approver）**：在系统内完成规则审核（由 `rule-configuration-system` 提供流程）。
- **检核发起人（Audit Initiator）**：选择产品/要件与规则，发起检核与复检。
- **检核结果审阅者（Reviewer）**：在线预览带批注文档、查看与导出报告。
- **系统管理员（Admin）**：管理规则模板、模型与向量库资源、阈值、配额、审计与权限。

## 3. 术语
- **要件/Artifact**：保险产品相关文档，如条款（Word）、精算报告、费率表、信息登记表（Excel）、可行性报告等。
- **匹配规则（单句/双句）**：针对文本 A 或文本 A 与 B 的出现关系进行检查。
- **格式规则**：针对字号、字体、加粗、缩进、行距、对齐、标题与序号层级等版式格式进行检查。
- **高级规则**：跨要件、多条件、多片段复合检核或需外部系统/模型结果协同的规则。
- **语义相似度/语义匹配**：通过向量化与相似度检索或 LLM 进行语义层面匹配。

## 4. 参考资料
- `Docs/intelligent-audit/智能校核引擎word-1.md`
- `Docs/intelligent-audit/智能校核引擎word-2.md`
- `Docs/intelligent-audit/智能检核需求1~6页.md`
- `Docs/intelligent-audit/智能检核需求7~12页.md`
- `Docs/intelligent-audit/产品要件检核规则集.md`

## 5. 目标与非目标
- **目标**：
  - ≥150 条规则的配置化执行，覆盖文本类、格式类、复合（高级）规则；
  - 支持语义相似度与语义匹配，提升查全/查准，减少误报；
  - 支持单个与批量检核、可多次变更规则后复检；
  - 在线预览带批注的结果、导出报告（含明细与建议修改）；
  - （调整）规则导入（Excel 模板）、版本化、状态流转（技术评估→系统内审核→上线）由 `rule-configuration-system` 提供；本模块仅消费生效规则与版本；
  - 向量检索（如 Milvus）与 LLM 能力可插拔；
  - 审计与可追溯：每条命中给出证据片段、匹配方式、阈值、版本信息。
- **非目标**：
  - 不构建通用办公自动化/知识库系统；
  - 不替代人工最终合规审核（提供辅助结论与证据）。

## 6. 用户故事与用例（EARS）
（需求编号前缀：IAER-）
- IAER-001 当检核发起人选择产品及其要件并选择“生效规则集”时，系统应执行匹配规则并输出命中项与证据片段。
- IAER-002 当检核发起人变更规则筛选条件并再次发起检核时，系统应基于新规则集复检并生成新报告，历史结果可追溯。
- IAER-003~006 规则配置相关能力由 `rule-configuration-system` 实现，非本模块范围。
- IAER-007 当规则进入“待技术评估/待提交审核/已提交审核/审核通过”等状态时，系统应完整记录状态与时间线（状态管理由 `rule-configuration-system` 提供，本模块读取）。
- IAER-008 当检核命中时，系统应在文档预览中以高亮/加粗/批注等方式标注，并在侧栏展示规则、证据与修改建议。
- IAER-009 当用户需要导出结果时，系统应支持导出 Word/PDF 报告与结构化 JSON（包括命中明细与上下文片段）。
- IAER-010 当批量检核 N 个产品且每产品≤1000句、规则数约100时，系统应在单产品≤1s 的量级内完成语义检索阶段并给出总体进度。
- IAER-011 当语义相似度不足以判定时，系统应支持回退到关键词/正则或触发 LLM 判定，并记录决策链与成本。
- IAER-012（调整）本阶段不对接 OA。系统内提交/审核由 `rule-configuration-system` 提供；本模块无需实现。
- IAER-013（调整）规则 Excel 模板的导入、字段校验、去重与版本化、批量生效与回滚由 `rule-configuration-system` 提供；本模块仅消费规则数据。
- IAER-014 当对 Excel“产品信息登记表”等要件检核时，系统应按规则定位工作表/单元格并校验填表规范与枚举项完整性。
- IAER-015 当规则更新版本上线后再次执行检核时，系统应按“规则-版本-阈值”配置执行，并将结果与版本绑定。

## 7. 功能性需求
### 7.1 规则类型与模板
- 单句匹配模板字段（示例，均需在系统中配置界面与校验）：
  - 规则管理部门、规则是否有效、规则来源、适用险种类别、适用经营区域/具体区域、适用产品性质、适用要件、规则描述、匹配章节、匹配内容A、匹配模式A（精准/模糊/语义阈值）、触发条件（A出现/A未出现/A单独出现）、提示类型（高亮/加粗/批注）、批注内容、是否仅首次提示。
- 双句匹配模板字段：
  - 在单句基础上增加匹配章节B、匹配内容B、匹配模式B、A与B关系（A出现B未出现/A出现B出现等）。
- 格式规则模板字段：
  - 匹配位置（标题/段落/序号/页脚等）、具体文本匹配内容（可空）、字体/字号/加粗、段落（缩进/对齐/段前后/行距）、行文要求、提示类型、批注内容。
- 高级规则模板字段：
  - 适用要件（可多选）、多条件描述、外部系统/模型依赖、输出与提示要求。
- 规则 Excel 模板的批量导入与导出由 `rule-configuration-system` 提供；本模块仅消费规则数据。

### 7.2 规则治理与生命周期
- 状态：待技术评估 → 待提交审核 → 已提交审核 → 审核通过；有效性：有效/无效/待开发上线。（状态管理由 `rule-configuration-system` 承担）
- 规则版本化：每次修改生成新版本；支持灰度生效与回滚；记录操作者与时间戳。（由 `rule-configuration-system` 提供）
- 审核：系统内提交/审核由 `rule-configuration-system` 提供；本模块仅读取状态，不实现外部对接。

### 7.3 检核执行
- 规则选择：按标签/关键字/文档内容筛选，支持对筛选集批量执行。
- 输入：产品集合、要件集合、规则集（含版本与阈值）。
- 匹配策略：
  1) 关键词/正则匹配；
  2) 语义相似度（句向量 + 向量检索，如 Milvus，TopK 可配，阈值可配）；
  3) 语义/LLM 推断（两种方案）：
     - 指令工程直推：低成本、易实现，但可追溯性弱；
     - 拆解为检核逻辑 + LLM 子任务：可评估、可追溯，稳定性更好（长上下文），代价是步骤与调用次数增加。
- 结果：命中项包含：规则ID/版本、命中证据片段（原文与相似度）、匹配方式与阈值、定位（章节/页/段/单元格）、建议文案、可视化批注（高亮/加粗/批注）。
- 复检：支持变更规则后二次检核；保留历史报告并可对比。
- 导出：Word/PDF 报告 + JSON（供系统间集成）。

### 7.4 文档与格式处理
- Word（.docx）：解析段落、样式、标题层级与序号（如“第一条”“（一）”“1.”“（1）”）、加粗、字体/字号、缩进、对齐、行距、页脚（如“第X页 共X页”）等；支持检测“保险责任”“责任免除”等标题是否加粗。
- Excel（.xlsx）：定位工作表/区域/单元格，校验填表说明、枚举完整性、区域约束（如经营范围与地域对应关系）。
- 文本切分：面向语义检索的句粒度切分与章节范围约束；支持全文与章节范围两种模式。

### 7.5 性能与并发（阶段目标）
- 单产品（≤1000句）× 100条规则：语义检索阶段 P95 ≤ 1s；总体检核（含加载与渲染）P95 ≤ 3s。
- 批量任务：支持 10 并发产品检核、队列与进度监控；支持夜间批处理 1万要件级任务。
- 向量库：支持 1024 维向量、IVF/Flat/HNSW 等索引策略，TopK 10/100 P95 参考 0.06s/0.07s（开源引擎场景）。

### 7.6 可观测性与可追溯
- 审计日志：规则选择、版本、阈值、匹配策略、模型版本、调用成本；
- 过程监控：任务进度（排队/执行/完成）、速率、错误；
- 结果追溯：每条命中项保留证据片段、相似度、来源页/段/单元格与截取上下文。

### 7.7 安全与合规
- 权限：与 `user-auth-system` 集成，按角色与数据域控制访问；
- 数据最小化：仅在本地/可信域内处理要件文本，避免敏感信息外传；
- 模型合规：LLM 走 `llm-service-management` 网关，支持脱敏与访问审计；
- 合规参考：《保险法》《健康保险管理办法》等（见规则来源字段）。

## 8. 非功能性需求
- 可用性：关键时间窗口可用性 ≥ 99.9%。
- 可维护性：规则模板、阈值、向量索引策略可配置；上线不需停机。
- 可扩展性：支持新增文档类型与规则类型的可插拔扩展点。
- 兼容性：支持常见 Office 版本（.docx/.xlsx）。
- 易用性：规则配置向导与字段校验由 `rule-configuration-system` 提供；引擎侧支持检核结果一键跳转到证据位置。
- 国际化/本地化：中文优先，保留英文扩展能力。

## 9. 数据与对象模型（逻辑）
- Rule（规则）{id, name, type, templateFields, tags, dept, source, applicableLines, regions, artifacts}
- RuleVersion {ruleId, version, status, effectiveFrom, effectiveTo, evaluator, approvalStatus}
- RuleSetSnapshot {id, ruleVersionIds, thresholds}
- AuditJob {id, creator, createdAt, products, artifacts, ruleSetSnapshotId, status}
- AuditTask {id, jobId, artifactRef, progress, timings}
- AuditHit {taskId, ruleVersionId, location, evidence, similarity, mode, suggestion}
- Document {id, type, contentRef, sections, stylesMeta}
- VectorIndex {artifactRef, sectionId, embeddingRef, modelTag}

## 10. 接口与集成
- 与 `product-document-management`：拉取产品与要件清单、文档存储引用。
- 与 `rule-configuration-system`：读取规则与版本；导入导出与状态流转由该模块负责；本模块按版本消费执行。
- 与 `audit-result-display`：在线预览带批注文档与列表、导出报告。
- 与 `llm-service-management`：统一调用 LLM（指令/子任务链），支持模型选择、限流与计费统计。

## 11. 约束与假设
- 语义向量检索优先用于粗召回，精排或裁决可结合关键词/正则或 LLM；
- Word/Excel 解析采用成熟库，格式元数据需完整可读；
- 受限于模型上下文，长文档采用分段策略与范围约束；
- 高级规则中的“系统暂无法实现”需经技术评估标注限制原因与替代方案（如人工提示）。

## 12. 验收标准与 SLA（示例）
- 功能验收：
  - 可执行单句、双句、格式、高级四类规则（由 `rule-configuration-system` 配置并生效）；
  - 支持批量与复检，结果可追溯；
  - 在线预览批注与导出报告可用。
- 质量与性能：
  - 典型场景下语义检索 P95 ≤ 1s/产品；
  - 命中项均含证据片段、定位与匹配方式说明；
  - 误报率与漏报率目标在试点集上评估并达成上线阈值（阈值由业务与技术共设）。

## 13. 溯源矩阵（片段）
- 文本/格式/高级规则模板字段：来源于 `智能检核需求1~6页.md` 与 `产品要件检核规则集.md`。
- 语义相似度/向量检索性能目标：来源于 `智能校核引擎word-2.md`（检索效率示例）。
- LLM 两种方案与差异：来源于 `智能检核需求7~12页.md`。
- 规则状态（系统内审核）：来源于 `智能校核引擎word-1.md` 与 `产品要件检核规则集.md`。